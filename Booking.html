<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Event Booking | Preethi Events</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    /* Dark Mode Body */
    body {
      background: #121212;
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 15px;
      color: #e5e7eb;
    }

    /* Booking Card */
    .booking-section {
      width: 100%;
      max-width: 1100px;
      background: #1f1f1f;
      border-radius: 24px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
      overflow: hidden;
      transition: all 0.4s ease;
      animation: fadeUp 0.6s ease-out;
    }

    @keyframes fadeUp {
      0% { opacity: 0; transform: translateY(40px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .poster {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 0;
    }

    .booking-info {
      padding: 50px;
    }

    .title {
      font-size: 2rem;
      font-weight: 700;
      color: #f3f4f6;
      margin-bottom: 12px;
      line-height: 1.3;
    }

    .price {
      font-size: 1.9rem;
      font-weight: 700;
      color: #f3f4f6;
      margin-bottom: 10px;
    }

    .price span {
      color: #EE5007; /* golden highlight for price */
      font-weight: 600;
      font-size: 1.9rem;
      margin-left: 4px;
    }

    .text-muted {
      color: #9ca3af !important;
    }

    .info-list {
      margin-top: 20px;
      margin-bottom: 20px;
    }

    .info-list div {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1rem;
      color: #d1d5db;
      margin-bottom: 8px;
    }

    .ticket-counter {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      margin: 25px 0;
    }

    .ticket-counter button {
      width: 44px;
      height: 44px;
      border: 1px solid #374151;
      background: #1f1f1f;
      border-radius: 10px;
      font-size: 1.3rem;
      font-weight: 600;
      color: #f3f4f6;
      transition: all 0.25s ease;
    }

    .ticket-counter button:hover {
      background: #EE5007;
      color: #1f1f1f;
      border-color: #EE5007;
    }

    .ticket-input {
      width: 75px;
      text-align: center;
      border-radius: 10px;
      border: 1px solid #374151;
      font-size: 1rem;
      padding: 8px;
      font-weight: 600;
      background-color: #121212;
      color: #f3f4f6;
    }

    .btn-checkout {
      background: #EE5007;
      color: white;
      border-radius: 12px;
      padding: 14px 0;
      font-weight: 600;
      font-size: 1.1rem;
      border: none;
      width: 100%;
      transition: all 0.3s ease;
    }

    .btn-checkout:hover {
      transform: translateY(-2px);
      box-shadow: #EE5007;
    }

    h5 {
      color: #f3f4f6;
    }

    .text-bg {
      color: #EE5007
    }

    @media(max-width: 992px) {
      body {
        padding: 20px;
      }

      .booking-section {
        flex-direction: column;
      }

      .booking-info {
        padding: 30px 20px;
      }

      .title {
        font-size: 1.6rem;
      }

      .price {
        font-size: 1.4rem;
      }

      .btn-checkout {
        font-size: 1rem;
      }
    }
  </style>
</head>

<body>
  <div class="booking-section row g-0">
    <!-- Image -->
    <div class="col-lg-6">
      <img id="bookingImage" src="" alt="Event Poster" class="poster img-fluid" />
    </div>

    <!-- Info -->
    <div class="col-lg-6 booking-info">
      <h2 id="bookingName" class="title">Event Name</h2>
      <p id="bookingDescription" class="text-muted">Loading event details...</p>

      <!-- Ticket Type Buttons -->
      <div class="ticket-types mb-3">
        <button class="btn btn-outline-primary me-2" id="btnBasic">Basic</button>
        <button class="btn btn-outline-secondary me-2" id="btnSilver">Silver</button>
        <button class="btn btn-outline-warning" id="btnGold">Gold</button>
      </div>

      <div class="price">$<span id="bookingCost">0</span> <small>Per ticket</small></div>

      <div class="info-list">
        <div><i class="bi bi-calendar-event-fill text-bg"></i> <span id="bookingDate"></span></div>
        <div><i class="bi bi-ticket-perforated-fill text-bg"></i> <span id="ticketsLeft"></span></div>
      </div>

      <div class="ticket-counter my-2">
        <button id="decrementBtn"><i class="bi bi-dash"></i></button>
        <input type="text" id="ticketCount" value="1" min="1" class="ticket-input" />
        <button id="incrementBtn"><i class="bi bi-plus"></i></button>
      </div>

      <h5 class="fw-semibold mb-4">Total: $<span id="totalPrice">0</span></h5>

      <button id="proceedBtn" class="btn-checkout">Proceed to Payment</button>
    </div>
  </div>

  <!-- Firebase + Stripe Logic -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA3ChaO6pXKubN4WeVffJK5q0tPmpT1XEc",
    authDomain: "partybooking-ecdf1.firebaseapp.com",
    databaseURL: "https://partybooking-ecdf1-default-rtdb.firebaseio.com",
    projectId: "partybooking-ecdf1",
    storageBucket: "partybooking-ecdf1.appspot.com",
    messagingSenderId: "119112973933",
    appId: "1:119112973933:web:87037ff1b10958bb118964",
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // DOM elements
  const bookingImage = document.getElementById("bookingImage");
  const bookingName = document.getElementById("bookingName");
  const bookingDescription = document.getElementById("bookingDescription");
  const bookingDate = document.getElementById("bookingDate");
  const bookingCost = document.getElementById("bookingCost");
  const ticketsLeft = document.getElementById("ticketsLeft");
  const ticketCount = document.getElementById("ticketCount");
  const totalPrice = document.getElementById("totalPrice");
  const incrementBtn = document.getElementById("incrementBtn");
  const decrementBtn = document.getElementById("decrementBtn");
  const proceedBtn = document.getElementById("proceedBtn");

  const btnBasic = document.getElementById("btnBasic");
  const btnSilver = document.getElementById("btnSilver");
  const btnGold = document.getElementById("btnGold");

  const urlParams = new URLSearchParams(window.location.search);
  const eventId = urlParams.get("id");

  let selectedType = "basic";
  let ticketsAvailable = 0;
  let costPerTicket = 0;
  let ticketsData = {}; // Store ticket info

  async function loadEvent() {
    const snapshot = await get(ref(db, `events/${eventId}`));
    if (!snapshot.exists()) return alert("Event not found!");
    const e = snapshot.val();

    bookingImage.src = e.imageUrl || "https://via.placeholder.com/400x400";
    bookingName.textContent = e.name;
    bookingDescription.textContent = e.description || "";

    // Format date
    if (e.dateTime) {
      const eventDate = new Date(e.dateTime);
      const dateOptions = { weekday: 'long', day: 'numeric', month: 'short' };
      const timeOptions = { hour: 'numeric', minute: '2-digit', hour12: true };
      bookingDate.textContent = `${eventDate.toLocaleDateString('en-US', dateOptions)} | ${eventDate.toLocaleTimeString('en-US', timeOptions)}`;
    } else {
      bookingDate.textContent = "TBD";
    }

    ticketsData = e.tickets || {};
    setTicketType(selectedType);
  }

  function setTicketType(type) {
    selectedType = type;
    const ticket = ticketsData[type] || { cost: 0, qty: null };

    // Update cost
    costPerTicket = ticket.cost || 0;
    bookingCost.textContent = costPerTicket;

    // Handle availability
    if (ticket.qty === 0) {
      ticketsAvailable = 0;
      ticketsLeft.textContent = "Sold Out";
      ticketCount.value = 0;
      proceedBtn.disabled = true;
    } else if (ticket.qty == null) {
      ticketsAvailable = Infinity;
      ticketsLeft.textContent = "Available";
      ticketCount.value = 1;
      proceedBtn.disabled = false;
    } else {
      ticketsAvailable = ticket.qty;
      ticketsLeft.textContent = `${ticketsAvailable} tickets left`;
      ticketCount.value = 1;
      proceedBtn.disabled = false;
    }

    updateTotal();
    highlightSelectedButton();
  }

  function highlightSelectedButton() {
    btnBasic.classList.toggle("btn-selected", selectedType === "basic");
    btnSilver.classList.toggle("btn-selected", selectedType === "silver");
    btnGold.classList.toggle("btn-selected", selectedType === "gold");
  }

  function updateTotal() {
    const count = Number(ticketCount.value) || 0;
    totalPrice.textContent = costPerTicket * count;
  }

  // Button events
  btnBasic.addEventListener("click", () => setTicketType("basic"));
  btnSilver.addEventListener("click", () => setTicketType("silver"));
  btnGold.addEventListener("click", () => setTicketType("gold"));

  incrementBtn.addEventListener("click", () => {
    if (Number(ticketCount.value) < ticketsAvailable)
      ticketCount.value = Number(ticketCount.value) + 1;
    updateTotal();
  });

  decrementBtn.addEventListener("click", () => {
    if (Number(ticketCount.value) > 1)
      ticketCount.value = Number(ticketCount.value) - 1;
    updateTotal();
  });

  ticketCount.addEventListener("input", () => {
    ticketCount.value = ticketCount.value.replace(/\D/g, '');
    if (ticketCount.value === "" || Number(ticketCount.value) < 1) ticketCount.value = 1;
    if (Number(ticketCount.value) > ticketsAvailable) ticketCount.value = ticketsAvailable;
    updateTotal();
  });

  proceedBtn.addEventListener("click", async () => {
    const ticketsSelected = Number(ticketCount.value);
    if (ticketsSelected > ticketsAvailable) return alert(`Only ${ticketsAvailable} tickets left for ${selectedType}!`);
    if (!auth.currentUser) return alert("Please login first!");

    const bookingId = "BK" + Date.now() + Math.floor(Math.random() * 1000);
    proceedBtn.disabled = true;
    proceedBtn.textContent = "Processing...";

    try {
      const response = await fetch("/.netlify/functions/createStripeSession", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          eventId,
          eventName: bookingName.textContent,
          tickets: ticketsSelected,
          totalAmount: costPerTicket * ticketsSelected,
          userId: auth.currentUser.uid,
          bookingId,
          ticketType: selectedType,
        }),
      });

      const data = await response.json();
      if (data.url) window.location.href = data.url;
      else alert("Failed to initiate payment.");
    } catch (err) {
      console.error(err);
      alert("Error creating payment session.");
    } finally {
      proceedBtn.disabled = false;
      proceedBtn.textContent = "Proceed to Payment";
    }
  });

  loadEvent();
</script>

<style>
  /* Highlight selected ticket type */
  .btn-selected {
    background-color: #0d6efd !important;
    color: white !important;
  }
</style>

</body>

</html>

<!-- Single Event Booking Page -->
<section class="booking-section">
  <div class="container">
    <div class="row align-items-center g-5">
      <!-- Left Column: Event Poster -->
      <div class="col-lg-6">
        <img id="bookingImage" src="" alt="Event Poster" class="img-fluid rounded shadow-lg poster">
      </div>

      <!-- Right Column: Event Details -->
      <div class="col-lg-6">
        <div class="details-card p-4 rounded shadow-lg">
          <h2 id="bookingName" class="title mb-3"></h2>
          <p id="bookingDescription" class="description mb-4"></p>

          <div class="info mb-3">
            <i class="bi bi-calendar-event-fill me-2"></i>
            <span id="bookingDate"></span>
          </div>

          <div class="info mb-3">
            <i class="bi bi-currency-dollar me-2"></i>
            Price per ticket: $<span id="bookingCost"></span>
          </div>

          <div class="info mb-4">
            <i class="bi bi-ticket-fill me-2"></i>
            <span id="ticketsLeft"></span>
          </div>

          <!-- Ticket Selector -->
          <div class="ticket-counter mb-4 d-flex align-items-center gap-3">
            <button id="decrementBtn" class="btn btn-outline-warning rounded-circle"><i class="bi bi-dash"></i></button>
            <input type="number" id="ticketCount" value="1" min="1" class="form-control ticket-input text-center fw-bold">
            <button id="incrementBtn" class="btn btn-outline-warning rounded-circle"><i class="bi bi-plus"></i></button>
          </div>

          <!-- Total Price -->
          <h4 class="total mb-4">Total: $<span id="totalPrice"></span></h4>

          <!-- Checkout Button -->
          <button id="proceedBtn" class="btn btn-warning w-100 fw-bold btn-lg">
            Proceed to Checkout <i class="bi bi-arrow-right-circle-fill ms-2"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA3ChaO6pXKubN4WeVffJK5q0tPmpT1XEc",
  authDomain: "partybooking-ecdf1.firebaseapp.com",
  databaseURL: "https://partybooking-ecdf1-default-rtdb.firebaseio.com",
  projectId: "partybooking-ecdf1",
  storageBucket: "partybooking-ecdf1.appspot.com",
  messagingSenderId: "119112973933",
  appId: "1:119112973933:web:87037ff1b10958bb118964",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// DOM
const bookingImage = document.getElementById("bookingImage");
const bookingName = document.getElementById("bookingName");
const bookingDescription = document.getElementById("bookingDescription");
const bookingDate = document.getElementById("bookingDate");
const bookingCost = document.getElementById("bookingCost");
const ticketsLeft = document.getElementById("ticketsLeft");
const ticketCount = document.getElementById("ticketCount");
const totalPrice = document.getElementById("totalPrice");
const incrementBtn = document.getElementById("incrementBtn");
const decrementBtn = document.getElementById("decrementBtn");
const proceedBtn = document.getElementById("proceedBtn");

// Event ID from URL
const urlParams = new URLSearchParams(window.location.search);
const eventId = urlParams.get("id");

let costPerTicket = 0;
let ticketsAvailable = 0;

// Load event details
async function loadEvent() {
  const snapshot = await get(ref(db, `events/${eventId}`));
  if (!snapshot.exists()) return alert("Event not found!");
  const e = snapshot.val();

  bookingImage.src = e.imageUrl || "https://via.placeholder.com/400x400";
  bookingName.textContent = e.name;
  bookingDescription.textContent = e.description || "";
  bookingDate.textContent = e.dateTime ? new Date(e.dateTime).toLocaleString() : "TBD";
  bookingCost.textContent = e.cost || 0;
  ticketsAvailable = e.tickets || 0;
  ticketsLeft.textContent = ticketsAvailable > 0 ? `${ticketsAvailable} tickets left` : "Sold Out";

  costPerTicket = e.cost || 0;
  totalPrice.textContent = costPerTicket;

  if (ticketsAvailable === 0) {
    ticketCount.value = 0;
    ticketCount.disabled = true;
    incrementBtn.disabled = true;
    decrementBtn.disabled = true;
    proceedBtn.disabled = true;
  }
}

// Update total price
function updateTotal() {
  const count = Number(ticketCount.value) || 1;
  totalPrice.textContent = costPerTicket * count;
}

// Increment/Decrement
incrementBtn.addEventListener("click", () => {
  if (Number(ticketCount.value) < ticketsAvailable) ticketCount.value = Number(ticketCount.value)+1;
  updateTotal();
});
decrementBtn.addEventListener("click", () => {
  if (Number(ticketCount.value) > 1) ticketCount.value = Number(ticketCount.value)-1;
  updateTotal();
});
ticketCount.addEventListener("input", () => {
  if (ticketCount.value < 1) ticketCount.value = 1;
  if (ticketCount.value > ticketsAvailable) ticketCount.value = ticketsAvailable;
  updateTotal();
});

// Proceed button â†’ Stripe
proceedBtn.addEventListener("click", async () => {
  const ticketsSelected = Number(ticketCount.value);
  if (ticketsSelected > ticketsAvailable) return alert(`Only ${ticketsAvailable} tickets left!`);

  const bookingId = 'BK' + Date.now() + Math.floor(Math.random()*1000);
  proceedBtn.disabled = true;
  proceedBtn.textContent = "Processing...";
  const userId = auth.currentUser.uid;

  try {
    const response = await fetch("/.netlify/functions/createStripeSession", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        eventId,
        eventName: bookingName.textContent,
        tickets: ticketsSelected,
        totalAmount: costPerTicket*ticketsSelected,
        userId: userId ,
        bookingId
      })
    });
    const data = await response.json();
    if (data.url) window.location.href = data.url;
    else alert("Failed to initiate payment.");
  } catch(err) {
    console.error(err);
    alert("Error creating payment session.");
  } finally {
    proceedBtn.disabled = false;
    proceedBtn.textContent = "Proceed to Pay";
  }
});

loadEvent();
</script>

<style>
body { background: #0f0f0f; font-family: 'Poppins', sans-serif; color: #fff; }

/* Poster */
.poster {
  width: 100%;
  border-radius: 20px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.7);
  transition: transform 0.3s ease;
}
.poster:hover { transform: scale(1.03); }

/* Details Card */
.details-card {
  background: #1c1c1c;
  border-radius: 20px;
  padding: 40px;
  box-shadow: 0 20px 50px rgba(0,0,0,0.7);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.details-card:hover { transform: translateY(-5px); box-shadow: 0 25px 60px rgba(0,0,0,0.8); }

.title { font-size: 2rem; font-weight: 700; color: #ffb400; }
.description { font-size: 1rem; color: #ddd; line-height: 1.6; }

.info { font-size: 1rem; color: #ddd; display: flex; align-items: center; gap: 0.5rem; }
.info i { color: #ffb400; font-size: 1.2rem; }

/* Ticket Counter */
.ticket-counter button {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  border: 2px solid #ffb400;
  background: transparent;
  transition: all 0.3s ease;
}
.ticket-counter button:hover { background: #ffb400; color: #000; }
.ticket-input {
  width: 70px;
  font-size: 1.2rem;
  background: #2a2a2a;
  color: #fff;
  border-radius: 12px;
  border: none;
}

/* Total Price */
.total { font-size: 1.5rem; font-weight: 700; }

/* Checkout Button */
.btn-warning {
  background: linear-gradient(90deg, #ffb400, #ff7a00);
  border-radius: 12px;
  font-weight: 600;
  font-size: 1.1rem;
  transition: all 0.3s ease;
}
.btn-warning:hover { background: linear-gradient(90deg, #ff7a00, #ffb400); }

/* Responsive */
@media(max-width:992px){
  .details-card { padding: 30px; }
  .poster { height: 300px; object-fit: cover; }
  .ticket-counter button { width: 45px; height: 45px; font-size: 1rem; }
  .ticket-input { width: 60px; font-size: 1rem; }
}
</style>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    body { display: flex; min-height: 100vh; background: #121212; color: #fff; }
    .sidebar { width: 220px; background: #1f1f1f; display: flex; flex-direction: column; padding: 20px; }
    .sidebar .brand { font-weight: bold; font-size: 1.2rem; margin-bottom: 2rem; }
    .sidebar .nav-link { color: #bbb; margin-bottom: 0.5rem; cursor: pointer; }
    .sidebar .nav-link.active { color: #fff; background: #333; border-radius: 5px; }
    .sidebar .user-info { margin-top: auto; }
    .main-content { flex: 1; padding: 30px; }
    .content-section { display: none; }
    .content-section.active { display: block; }
    input, textarea { background: #2c2c2c !important; color: #fff !important; border: 1px solid #444; border-radius: 6px; }
    input::placeholder, textarea::placeholder { color: #aaa; opacity: 1; }
    label { color: #ccc; }
    .bg-dark { background-color: #1f1f1f !important; }
    .btn-primary { background-color: #0d6efd; border-color: #0d6efd; font-weight: 500; transition: all 0.2s; }
    .btn-primary:hover { background-color: #0b5ed7; border-color: #0a58ca; }
    .card.bg-dark { padding: 2rem; border-radius: 12px; }
    .upload-box { background: #2c2c2c; border: 2px dashed #555; transition: all 0.3s ease; cursor: pointer; }
    .upload-box:hover { border-color: #0d6efd; background: #1e1e1e; }
    .upload-box.dragover { border-color: #0d6efd; background: rgba(13, 110, 253, 0.1); }
    .form-control-dark:focus { border-color: #0d6efd; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, .25); }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="brand" id="loggedUser">Hi, User</div>
    <ul class="nav flex-column">
      <li><a class="nav-link active" data-section="dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
      <li><a class="nav-link" data-section="add-event"><i class="bi bi-plus-circle"></i> Add Event</a></li>
      <li><a class="nav-link" data-section="list-events"><i class="bi bi-list-task"></i> List Events</a></li>
      <li><a class="nav-link" data-section="bookings"><i class="bi bi-journal-check"></i> Bookings</a></li>
    </ul>
    <div class="user-info mt-auto">
      <button class="btn btn-danger mt-3 w-100" id="logoutBtn"><i class="bi bi-box-arrow-right"></i> Logout</button>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Dashboard -->
    <div id="dashboard" class="content-section active">
      <h1 class="mb-4">Dashboard Overview</h1>
      <div class="row g-4">
        <div class="col-md-4"><div class="p-4 bg-dark rounded-3 shadow-sm"><h5><i class="bi bi-plus-circle"></i> Add Event</h5><p>Create and publish new events.</p></div></div>
        <div class="col-md-4"><div class="p-4 bg-dark rounded-3 shadow-sm"><h5><i class="bi bi-list-task"></i> List Events</h5><p>View or manage your existing events.</p></div></div>
        <div class="col-md-4"><div class="p-4 bg-dark rounded-3 shadow-sm"><h5><i class="bi bi-people"></i> Manage Bookings</h5><p>View bookings made by users.</p></div></div>
      </div>
    </div>

    <!-- Add Event Section -->
    <div id="add-event" class="content-section">
      <h1 class="mb-4">Add Event</h1>
      <div class="card bg-dark text-white shadow-sm border-0">
        <div class="card-body">
          <form id="addEventForm">
            <div class="mb-4">
              <label class="form-label">Event Image</label>
              <div id="dropZone" class="upload-box text-center p-4 rounded border border-secondary">
                <i class="bi bi-cloud-upload display-4 text-primary"></i>
                <p class="mt-3 mb-1 fw-bold">Drag & drop your image here</p>
                <p class="text-white small">or click to browse files</p>
                <input type="file" id="eventImage" accept="image/*" hidden required>
              </div>
              <div id="previewContainer" class="mt-3 text-center" style="display:none;">
                <img id="imagePreview" class="img-fluid rounded shadow-sm" style="max-height:200px;object-fit:cover;">
              </div>
            </div>

            <div class="mb-3"><label class="form-label">Event Name</label><input type="text" class="form-control" id="eventName" required></div>
            <div class="mb-3"><label class="form-label">Date & Time</label><input type="datetime-local" class="form-control" id="eventDateTime" required></div>
            <div class="mb-3"><label class="form-label">Description</label><textarea class="form-control" rows="3" id="eventDescription"></textarea></div>

            <!-- Ticket Types -->
            <div class="mb-3"><label class="form-label">Ticket Types & Prices</label>
              <div class="row g-2">
                <div class="col-md-4">
                  <input type="number" class="form-control" id="ticketBasicCost" placeholder="Basic Ticket Cost" required>
                  <input type="number" class="form-control mt-1" id="ticketBasicQty" placeholder="Basic Ticket Qty (optional)">
                </div>
                <div class="col-md-4">
                  <input type="number" class="form-control" id="ticketSilverCost" placeholder="Silver Ticket Cost" required>
                  <input type="number" class="form-control mt-1" id="ticketSilverQty" placeholder="Silver Ticket Qty (optional)">
                </div>
                <div class="col-md-4">
                  <input type="number" class="form-control" id="ticketGoldCost" placeholder="Gold Ticket Cost" required>
                  <input type="number" class="form-control mt-1" id="ticketGoldQty" placeholder="Gold Ticket Qty (optional)">
                </div>
              </div>
            </div>

            <button type="submit" class="btn btn-primary w-100 mt-2 shadow-sm"><i class="bi bi-plus-circle me-2"></i> Create Event</button>
          </form>
        </div>
      </div>
    </div>

    <!-- List Events Section -->
    <div id="list-events" class="content-section">
      <h1 class="mb-4">List Events</h1>
      <div id="eventsContainer" class="row g-3"></div>

      <!-- Edit Event Modal -->
      <div class="modal fade" id="editEventModal" tabindex="-1" aria-labelledby="editEventLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-secondary">
              <h5 class="modal-title" id="editEventLabel">Edit Event</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="editEventForm">
                <input type="hidden" id="editEventId">

                <div class="mb-3 text-center">
                  <label class="form-label">Current Event Image</label>
                  <div>
                    <img id="editEventPreview" src="" alt="Event Image" class="img-fluid rounded mb-2" style="max-height:200px;">
                  </div>
                  <input type="file" class="form-control" id="editEventImage" accept="image/*">
                  <small class="text-secondary">Leave empty to keep existing image.</small>
                </div>

                <div class="mb-3"><label class="form-label">Event Name</label><input type="text" class="form-control" id="editEventName" required></div>
                <div class="mb-3"><label class="form-label">Date & Time</label><input type="datetime-local" class="form-control" id="editEventDateTime" required></div>
                <div class="mb-3"><label class="form-label">Description</label><textarea class="form-control" rows="3" id="editEventDescription"></textarea></div>

                <!-- Edit Ticket Types -->
                <div class="mb-3"><label class="form-label">Ticket Types & Prices</label>
                  <div class="row g-2">
                    <div class="col-md-4">
                      <input type="number" class="form-control" id="editTicketBasicCost" placeholder="Basic Ticket Cost" required>
                      <input type="number" class="form-control mt-1" id="editTicketBasicQty" placeholder="Basic Ticket Qty (optional)">
                    </div>
                    <div class="col-md-4">
                      <input type="number" class="form-control" id="editTicketSilverCost" placeholder="Silver Ticket Cost" required>
                      <input type="number" class="form-control mt-1" id="editTicketSilverQty" placeholder="Silver Ticket Qty (optional)">
                    </div>
                    <div class="col-md-4">
                      <input type="number" class="form-control" id="editTicketGoldCost" placeholder="Gold Ticket Cost" required>
                      <input type="number" class="form-control mt-1" id="editTicketGoldQty" placeholder="Gold Ticket Qty (optional)">
                    </div>
                  </div>
                </div>

                <button type="submit" class="btn btn-primary w-100 mt-2">Update Event</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bookings Section -->
    <div id="bookings" class="content-section">
  <h1 class="mb-4 text-white">Bookings</h1>
  <div class="card bg-dark text-white shadow border-0 rounded-4">
    <div class="card-body p-4" style="background: linear-gradient(145deg, #1e1e1e, #2a2a2a); border-radius: 20px; width: 100%; max-width: 1400px; margin: auto;">
      <div class="table-responsive">
        <table class="table table-dark table-striped table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Booking ID</th>
              <th>Event Name</th>
              <th>Tickets</th>
              <th>Total</th>
              <th>Booked By</th>
              <th>Status</th>
              <th>PaymentId</th>
              <th>Created At</th>
            </tr>
          </thead>
          <tbody id="bookingsContainer"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>


  </div>

  <!-- Bootstrap & Firebase -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA3ChaO6pXKubN4WeVffJK5q0tPmpT1XEc",
      authDomain: "partybooking-ecdf1.firebaseapp.com",
      databaseURL: "https://partybooking-ecdf1-default-rtdb.firebaseio.com",
      projectId: "partybooking-ecdf1",
      storageBucket: "partybooking-ecdf1.appspot.com",
      messagingSenderId: "119112973933",
      appId: "1:119112973933:web:87037ff1b10958bb118964",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    const loggedUser = document.getElementById("loggedUser");
    const logoutBtn = document.getElementById("logoutBtn");
    const navLinks = document.querySelectorAll(".nav-link[data-section]");
    const sections = document.querySelectorAll(".content-section");

    // Auth
    onAuthStateChanged(auth, (user) => {
      if (user) loggedUser.textContent = `Hi, ${user.displayName || user.email.split("@")[0]}`;
      else window.location.href = "admin.html";
    });

    logoutBtn.addEventListener("click", () => signOut(auth).then(() => window.location.href = "admin.html"));

    // Navigation
    navLinks.forEach(link => {
      link.addEventListener("click", e => {
        e.preventDefault();
        const target = link.getAttribute("data-section");
        sections.forEach(s => s.classList.remove("active"));
        document.getElementById(target).classList.add("active");
        navLinks.forEach(l => l.classList.remove("active"));
        link.classList.add("active");

        if (target === "list-events") loadEvents();
        else if (target === "bookings") loadBookings();
      });
    });

    // Drag-Drop Image Upload
    const dropZone = document.getElementById("dropZone");
    const eventImageInput = document.getElementById("eventImage");
    const previewContainer = document.getElementById("previewContainer");
    const imagePreview = document.getElementById("imagePreview");

    dropZone.addEventListener("click", () => eventImageInput.click());
    dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("dragover"); });
    dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
    dropZone.addEventListener("drop", e => {
      e.preventDefault(); dropZone.classList.remove("dragover");
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith("image/")) { eventImageInput.files = e.dataTransfer.files; previewImage(file); }
    });
    eventImageInput.addEventListener("change", e => { const f = e.target.files[0]; if (f && f.type.startsWith("image/")) previewImage(f); });
    function previewImage(file) { const reader = new FileReader(); reader.onload = e => { previewContainer.style.display = "block"; imagePreview.src = e.target.result; }; reader.readAsDataURL(file); }

    // Add Event
    document.getElementById("addEventForm").addEventListener("submit", async e => {
      e.preventDefault();
      const name = eventName.value;
      const dateTime = eventDateTime.value;
      const description = eventDescription.value;

      const tickets = {
        basic: { cost: Number(ticketBasicCost.value), qty: ticketBasicQty.value ? Number(ticketBasicQty.value) : null },
        silver: { cost: Number(ticketSilverCost.value), qty: ticketSilverQty.value ? Number(ticketSilverQty.value) : null },
        gold: { cost: Number(ticketGoldCost.value), qty: ticketGoldQty.value ? Number(ticketGoldQty.value) : null }
      };

      const imageFile = eventImage.files[0];
      if (!imageFile) return alert("Select an image");

      try {
        const formData = new FormData();
        formData.append("file", imageFile);
        formData.append("upload_preset", "EventBooking");
        formData.append("folder", "events");

        const res = await fetch(`https://api.cloudinary.com/v1_1/djtmeloko/image/upload`, { method: "POST", body: formData });
        const data = await res.json();
        const imageUrl = data.secure_url;

        const newEventRef = push(ref(database, "events/"));
        await set(newEventRef, { 
          name,
          dateTime,
          description,
          tickets,
          imageUrl,
          stripeAccountId: "acct_1SKgyfIzm2enTAkA",
          createdBy: auth.currentUser.uid,
          createdAt: new Date().toISOString()
        });

        alert("Event created successfully!");
        e.target.reset();
        previewContainer.style.display = "none";
      } catch (err) { 
        console.error(err); 
        alert("Failed to create event."); 
      }
    });

    // Load Events
    async function loadEvents() {
      const eventsContainer = document.getElementById("eventsContainer");
      eventsContainer.innerHTML = "";
      const snapshot = await get(ref(database, "events/"));
      if (snapshot.exists()) {
        const events = snapshot.val();
        Object.keys(events).forEach(id => {
          const e = events[id];
          let ticketInfo = "";
          if(e.tickets){
            ["basic","silver","gold"].forEach(type=>{
              const t = e.tickets[type];
              if(t && t.cost) ticketInfo += `<p class="mb-1"><strong>${type.charAt(0).toUpperCase()+type.slice(1)}:</strong> $${t.cost}${t.qty ? ` | ${t.qty} tickets` : ""}</p>`;
            });
          }
          eventsContainer.innerHTML += `
            <div class="col-md-4">
              <div class="p-3 bg-dark rounded-3 shadow-sm h-100 d-flex flex-column">
                <img src="${e.imageUrl}" class="img-fluid mb-2 rounded" alt="Event Image" style="height:200px;object-fit:cover;">
                <h5 class="text-primary">${e.name}</h5>
                <p class="small mb-1">${e.description || ""}</p>
                <p class="mb-1"><i class="bi bi-calendar-event"></i> ${new Date(e.dateTime).toLocaleString()}</p>
                ${ticketInfo}
                <div class="mt-auto d-flex justify-content-between">
                  <button class="btn btn-sm btn-outline-light me-2" onclick="openEditModal('${id}')"><i class="bi bi-pencil"></i> Edit</button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteEvent('${id}')"><i class="bi bi-trash"></i> Delete</button>
                </div>
              </div>
            </div>`;
        });
      }
    }

    window.openEditModal = async function(id){
      const snapshot = await get(ref(database, `events/${id}`));
      if(!snapshot.exists()) return alert("Event not found");
      const e = snapshot.val();
      document.getElementById("editEventId").value = id;
      document.getElementById("editEventName").value = e.name;
      document.getElementById("editEventDateTime").value = e.dateTime;
      document.getElementById("editEventDescription").value = e.description;
      document.getElementById("editEventPreview").src = e.imageUrl;
      document.getElementById("editEventPreview").dataset.oldUrl = e.imageUrl;
      if(e.tickets){
        ["Basic","Silver","Gold"].forEach(type=>{
          const t = e.tickets[type.toLowerCase()];
          if(t){ document.getElementById("editTicket"+type+"Cost").value = t.cost; document.getElementById("editTicket"+type+"Qty").value = t.qty || ""; }
        });
      }
      new bootstrap.Modal(document.getElementById("editEventModal")).show();
    }

    // Edit Event
    document.getElementById("editEventForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = editEventId.value;
      const editEventImage = document.getElementById("editEventImage");
      const editEventPreview = document.getElementById("editEventPreview");
      let imageUrl = editEventPreview.dataset.oldUrl;

      try {
        const newImage = editEventImage.files[0];
        if (newImage) {
          const formData = new FormData();
          formData.append("file", newImage);
          formData.append("upload_preset", "eventBooking");
          formData.append("folder", "events");
          const res = await fetch(`https://api.cloudinary.com/v1_1/dtwcxssvj/image/upload`, { method: "POST", body: formData });
          const data = await res.json();
          if (data.secure_url) imageUrl = data.secure_url;
          else throw new Error("Image upload failed");
        }

        const snapshot = await get(ref(database, `events/${id}`));
        const oldEvent = snapshot.exists() ? snapshot.val() : {};

        const tickets = {
          basic: { cost: Number(editTicketBasicCost.value), qty: editTicketBasicQty.value ? Number(editTicketBasicQty.value) : null },
          silver: { cost: Number(editTicketSilverCost.value), qty: editTicketSilverQty.value ? Number(editTicketSilverQty.value) : null },
          gold: { cost: Number(editTicketGoldCost.value), qty: editTicketGoldQty.value ? Number(editTicketGoldQty.value) : null }
        };

        const updatedEvent = {
          name: editEventName.value,
          dateTime: editEventDateTime.value,
          description: editEventDescription.value,
          tickets,
          imageUrl,
          stripeAccountId: oldEvent.stripeAccountId || "acct_1SI2NnIzm242HFji"
        };

        await set(ref(database, `events/${id}`), updatedEvent);
        alert("Event updated successfully!");
        bootstrap.Modal.getInstance(editEventModal).hide();
        loadEvents();
      } catch (err) {
        console.error(err);
        alert("Failed to update event.");
      }
    });

    window.deleteEvent = async function(id){
      if(!confirm("Are you sure you want to delete this event?")) return;
      await set(ref(database, `events/${id}`), null);
      alert("Event deleted!");
      loadEvents();
    }

    // Load Bookings (example)
   async function loadBookings() {
  const tbody = document.getElementById("bookingsContainer");
  tbody.innerHTML = "";

  const snapshot = await get(ref(database, "bookings/"));
  if (snapshot.exists()) {
    const bookings = snapshot.val();

    // Convert Firebase object to array with ID
    const bookingsArray = Object.keys(bookings).map((id) => ({
      id,
      ...bookings[id],
    }));

    // ✅ Sort by createdAt in DESCENDING order (newest → oldest)
    bookingsArray.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

    // Helper function: time ago
    function timeAgo(date) {
      const seconds = Math.floor((new Date() - new Date(date)) / 1000);
      const intervals = {
        year: 31536000,
        month: 2592000,
        week: 604800,
        day: 86400,
        hour: 3600,
        minute: 60,
      };
      for (const [unit, value] of Object.entries(intervals)) {
        const interval = Math.floor(seconds / value);
        if (interval >= 1) {
          return `${interval} ${unit}${interval > 1 ? "s" : ""} ago`;
        }
      }
      return "just now";
    }
    

    // ✅ Loop through sorted array
    bookingsArray.forEach((b, index) => {
      let ticketInfo = "";
      if (b.tickets) {
        Object.keys(b.tickets).forEach((type) => {
          const t = b.tickets[type];
          if (t) ticketInfo += `${type.charAt(0).toUpperCase() + type.slice(1)}: ${t.qty} | `;
        });
        ticketInfo = ticketInfo.slice(0, -3);
      }

      tbody.innerHTML += `
        <tr>
          <td>${b.bookingId}</td>
          <td>${b.eventName} (${b.ticketType || "-"})</td>
          <td>${b.tickets || "-" }</td>
          <td>$${b.totalAmount || 0}</td>
          <td>${b.bookedBy || "-"}</td>
          <td>${b.status || "-"}</td>
          <td>${b.paymentId || "-"}</td>
          <td>${timeAgo(b.createdAt)}</td>
        </tr>`;
    });
  }
}


  </script>
  
  <!-- No Inspect -->

<script>
// Disable right-click context menu
document.addEventListener("contextmenu", function (event) {
  event.preventDefault();
});

// Disable common inspect shortcuts
document.addEventListener("keydown", function (event) {
  // F12
  if (event.key === "F12") {
    event.preventDefault();
  }
  // Ctrl+Shift+I or Ctrl+Shift+J or Ctrl+U or Ctrl+S
  if (
    (event.ctrlKey && event.shiftKey && (event.key === "I" || event.key === "J")) ||
    (event.ctrlKey && (event.key === "U" || event.key === "S"))
  ) {
    event.preventDefault();
  }
});
</script>

</body>
</html>
